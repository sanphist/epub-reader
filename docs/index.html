
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB é«˜äº®è¯è¡¨é˜…è¯»å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%;
      font-family: "Microsoft YaHei Light", sans-serif;
      display: flex; flex-direction: column;
      background: #f7f7f7;
    }
    #top-bar {
      padding: 6px; background: #eee;
      display: flex; flex-wrap: wrap;
      align-items: center; gap: 5px;
    }
    #viewer {
      flex-grow: 1; width: 100%;
      overflow: auto; background: #fff;
    }
    #status {
      font-size: 12px; padding: 5px;
      background: #fff8dc; height: 22px;
    }
    mark.highlight {
      background-color: yellow;
    }
    body.dark {
      background: #121212; color: #eee;
    }
    body.dark #viewer {
      background: #1e1e1e; color: #ddd;
    }
  </style>
</head>
<body>
  <div id="top-bar">
    <input type="file" id="upload" accept=".epub" />
    <select id="chapters"><option>ğŸ“– é€‰æ‹©ç« èŠ‚</option></select>
    <button id="prev">â¬… ä¸Šä¸€é¡µ</button>
    <button id="next">â¡ ä¸‹ä¸€é¡µ</button>
    <button id="nextChapter">â© ä¸‹ä¸€ç« </button>
    <select id="fontSelect">
      <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
      <option value="serif">Serif</option>
      <option value="sans-serif">é»˜è®¤å­—ä½“</option>
    </select>
    <button id="incFont">ğŸ”¼ å­—å¤§</button>
    <button id="decFont">ğŸ”½ å­—å°</button>
    <button id="toggleDark">ğŸŒ™ å¤œé—´</button>
    <input type="file" id="dictUpload" accept=".txt,.xlsx">
    <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="lightblue">æµ…è“</option></select>
    <label><input type="checkbox" id="case"> åŒºåˆ†å¤§å°å†™</label>
  </div>
  <div id="viewer"></div>
  <div id="status">ğŸ“„ ç­‰å¾…åŠ è½½ EPUB...</div>

  <script>
    let book, rendition, highlights = new Set(), fontSize = 100, color = "yellow", isDark = false;
    let caseSensitive = false;

    const $ = id => document.getElementById(id);

    function applyTheme() {
      if (!rendition) return;
      rendition.themes.register("custom", {
        "body": {
          "font-family": $("fontSelect").value,
          "font-size": fontSize + "%",
          "background": isDark ? "#1e1e1e" : "#ffffff",
          "color": isDark ? "#ddd" : "#000"
        }
      });
      rendition.themes.select("custom");
    }

    function highlightText(doc) {
      if (!highlights.size) return;
      let words = [...highlights].sort((a,b)=>b.length-a.length).map(w=>w.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
      let reg = new RegExp("\\b(" + words.join("|") + ")\\b", caseSensitive ? "g" : "gi");
      let walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
      while (walker.nextNode()) {
        let node = walker.currentNode;
        if (!node.nodeValue.trim()) continue;
        let span = document.createElement("span");
        span.innerHTML = node.nodeValue.replace(reg, m => `<mark class='highlight' style='background-color:${color}'>${m}</mark>`);
        if (span.innerHTML !== node.nodeValue) node.parentNode.replaceChild(span, node);
      }
    }

    $("upload").onchange = function () {
      let file = this.files[0];
      book = ePub(file);
      rendition = book.renderTo("viewer", {
        flow: "scrolled-doc",
        width: "100%", height: "100%"
      });
      rendition.display();

      book.loaded.navigation.then(nav => {
        $("chapters").innerHTML = nav.toc.map(c => `<option value="${c.href}">${c.label}</option>`).join('');
      });

      rendition.on("rendered", () => {
        applyTheme();
        let ifr = $("viewer").querySelector("iframe");
        if (ifr) highlightText(ifr.contentDocument);
      });
    };

    $("chapters").onchange = () => rendition.display($("chapters").value);
    $("prev").onclick = () => rendition.prev();
    $("next").onclick = () => rendition.next();
    $("nextChapter").onclick = () => {
      let items = book.spine.spineItems;
      let idx = items.findIndex(i => i.href === rendition.location.start.href);
      if (idx < items.length - 1) rendition.display(items[idx + 1].href);
    };

    $("fontSelect").onchange = applyTheme;
    $("incFont").onclick = () => { fontSize += 10; applyTheme(); };
    $("decFont").onclick = () => { fontSize -= 10; applyTheme(); };
    $("toggleDark").onclick = () => {
      isDark = !isDark;
      document.body.classList.toggle("dark", isDark);
      applyTheme();
    };
    $("colorSelect").onchange = () => color = $("colorSelect").value;
    $("case").onchange = () => caseSensitive = $("case").checked;

    $("dictUpload").onchange = async function () {
      highlights.clear();
      let file = this.files[0];
      if (file.name.endsWith(".txt")) {
        let text = await file.text();
        text.split(/\r?\n/).forEach(w => highlights.add(w.trim()));
      } else if (file.name.endsWith(".xlsx")) {
        let data = await file.arrayBuffer();
        let wb = XLSX.read(data, { type: "array" });
        XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }).forEach(r => {
          if (r[0]) highlights.add(r[0].toString().trim());
        });
      }
      $("status").textContent = "âœ… å·²åŠ è½½è¯è¡¨ï¼š" + highlights.size + " é¡¹";
      if (rendition) rendition.display(rendition.location.start.href);
    };
  </script>
</body>
</html>
