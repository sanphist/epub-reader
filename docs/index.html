

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>完整版 EPUB 高亮词表阅读器（修正版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif;background:#f7f7f7;}
    #top-bar{padding:5px;background:#eee;display:flex;flex-wrap:wrap;gap:4px;align-items:center;}
    #viewer{height:calc(100% - 70px);background:#fff;overflow:auto;}
    #status{height:20px;padding:4px;font-size:12px;background:#fffae6;}
    .highlight{background-color:yellow;}
    .dark-mode{background:#121212;color:#eaeaea;}
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>请选择章节</option></select>
  <button id="prev">⬅️上一页</button>
  <button id="next">➡️下一页</button>
  <button id="nextChapter">⏩下一章</button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">微软雅黑 Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans-serif</option>
  </select>
  <button id="increaseFont">🔼增字号</button>
  <button id="decreaseFont">🔽减字号</button>
  <button id="toggleNight">🌙夜间模式</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">黄色</option><option value="pink">粉色</option></select>
  <label><input type="checkbox" id="caseSensitive">大小写敏感</label>
</div>
<div id="viewer"></div>
<div id="status">📖等待上传EPUB...</div>

<script>
let book,rendition,highlights=new Set(),isDark=false,fontSize=100,highlightColor='yellow',caseSensitive=false;

upload.onchange=function(){
  book=ePub(this.files[0]);
  rendition=book.renderTo("viewer",{flow:"scrolled",width:"100%",height:"100%"});
  rendition.display();
  book.loaded.navigation.then(nav=>{
    chapters.innerHTML=nav.toc.map(c=>`<option value="${c.href}">${c.label}</option>`).join('');
  });
  rendition.on("rendered",()=>{
    applyTheme();
    applyHighlights();
  });
};

function applyTheme(){
  rendition.themes.register("custom",{body:{"font-family":fontSelect.value,"font-size":fontSize+"%",color:isDark?"#eee":"#000",background:isDark?"#121212":"#fff"}});
  rendition.themes.select("custom");
}

function applyHighlights(){
  rendition.getContents().forEach(c=>{
    highlights.forEach(word=>{
      const reg=new RegExp(`\b(${word})\b`,caseSensitive?"g":"gi");
      c.document.body.innerHTML=c.document.body.innerHTML.replace(reg,`<mark class="highlight" style="background-color:${highlightColor}">$1</mark>`);
    });
  });
}

chapters.onchange=()=>rendition.display(chapters.value);
prev.onclick=()=>rendition.prev();
next.onclick=()=>rendition.next();

nextChapter.onclick=()=>{
  let spine=book.spine.spineItems,idx=spine.findIndex(i=>i.href==rendition.location.start.href);
  if(idx<spine.length-1)rendition.display(spine[idx+1].href);else alert('已是最后一章');
};

increaseFont.onclick=()=>{fontSize+=10;applyTheme();};
decreaseFont.onclick=()=>{fontSize-=10;applyTheme();};
fontSelect.onchange=applyTheme;
toggleNight.onclick=()=>{isDark=!isDark;applyTheme();};
colorSelect.onchange=()=>{highlightColor=colorSelect.value;applyHighlights();};
caseSensitive.onclick=()=>{caseSensitive=caseSensitive.checked;applyHighlights();};

dictUpload.onchange=async()=>{
  highlights.clear();let f=this.files[0];
  if(f.name.endsWith('.txt'))(await f.text()).split(/
?
/).map(l=>highlights.add(l.trim()));
  else if(f.name.endsWith('.xlsx'))XLSX.utils.sheet_to_json(XLSX.read(await f.arrayBuffer()).Sheets.Sheet1,{header:1}).map(r=>highlights.add(r[0].trim()));
  status.textContent=`✅已加载词表:${highlights.size}个`;applyHighlights();
};
</script>
</body>
</html>
