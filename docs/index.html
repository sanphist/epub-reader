

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®Œæ•´ç‰ˆ EPUB é«˜äº®è¯è¡¨é˜…è¯»å™¨ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;overflow:hidden;font-family:sans-serif;background:#f7f7f7;}
    #top-bar{padding:5px;background:#eee;display:flex;flex-wrap:wrap;gap:4px;align-items:center;}
    #viewer{height:calc(100% - 70px);background:#fff;overflow:auto;}
    #status{height:20px;padding:4px;font-size:12px;background:#fffae6;}
    .highlight{background-color:yellow;}
    .dark-mode{background:#121212;color:#eaeaea;}
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>è¯·é€‰æ‹©ç« èŠ‚</option></select>
  <button id="prev">â¬…ï¸ä¸Šä¸€é¡µ</button>
  <button id="next">â¡ï¸ä¸‹ä¸€é¡µ</button>
  <button id="nextChapter">â©ä¸‹ä¸€ç« </button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">Sans-serif</option>
  </select>
  <button id="increaseFont">ğŸ”¼å¢å­—å·</button>
  <button id="decreaseFont">ğŸ”½å‡å­—å·</button>
  <button id="toggleNight">ğŸŒ™å¤œé—´æ¨¡å¼</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="pink">ç²‰è‰²</option></select>
  <label><input type="checkbox" id="caseSensitive">å¤§å°å†™æ•æ„Ÿ</label>
</div>
<div id="viewer"></div>
<div id="status">ğŸ“–ç­‰å¾…ä¸Šä¼ EPUB...</div>

<script>
let book,rendition,highlights=new Set(),isDark=false,fontSize=100,highlightColor='yellow',caseSensitive=false;

upload.onchange=function(){
  book=ePub(this.files[0]);
  rendition=book.renderTo("viewer",{flow:"scrolled",width:"100%",height:"100%"});
  rendition.display();
  book.loaded.navigation.then(nav=>{
    chapters.innerHTML=nav.toc.map(c=>`<option value="${c.href}">${c.label}</option>`).join('');
  });
  rendition.on("rendered",()=>{
    applyTheme();
    applyHighlights();
  });
};

function applyTheme(){
  rendition.themes.register("custom",{body:{"font-family":fontSelect.value,"font-size":fontSize+"%",color:isDark?"#eee":"#000",background:isDark?"#121212":"#fff"}});
  rendition.themes.select("custom");
}

function applyHighlights(){
  rendition.getContents().forEach(c=>{
    highlights.forEach(word=>{
      const reg=new RegExp(`\b(${word})\b`,caseSensitive?"g":"gi");
      c.document.body.innerHTML=c.document.body.innerHTML.replace(reg,`<mark class="highlight" style="background-color:${highlightColor}">$1</mark>`);
    });
  });
}

chapters.onchange=()=>rendition.display(chapters.value);
prev.onclick=()=>rendition.prev();
next.onclick=()=>rendition.next();

nextChapter.onclick=()=>{
  let spine=book.spine.spineItems,idx=spine.findIndex(i=>i.href==rendition.location.start.href);
  if(idx<spine.length-1)rendition.display(spine[idx+1].href);else alert('å·²æ˜¯æœ€åä¸€ç« ');
};

increaseFont.onclick=()=>{fontSize+=10;applyTheme();};
decreaseFont.onclick=()=>{fontSize-=10;applyTheme();};
fontSelect.onchange=applyTheme;
toggleNight.onclick=()=>{isDark=!isDark;applyTheme();};
colorSelect.onchange=()=>{highlightColor=colorSelect.value;applyHighlights();};
caseSensitive.onclick=()=>{caseSensitive=caseSensitive.checked;applyHighlights();};

dictUpload.onchange=async()=>{
  highlights.clear();let f=this.files[0];
  if(f.name.endsWith('.txt'))(await f.text()).split(/
?
/).map(l=>highlights.add(l.trim()));
  else if(f.name.endsWith('.xlsx'))XLSX.utils.sheet_to_json(XLSX.read(await f.arrayBuffer()).Sheets.Sheet1,{header:1}).map(r=>highlights.add(r[0].trim()));
  status.textContent=`âœ…å·²åŠ è½½è¯è¡¨:${highlights.size}ä¸ª`;applyHighlights();
};
</script>
</body>
</html>
