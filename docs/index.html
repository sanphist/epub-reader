
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB é«˜äº®è¯è¡¨é˜…è¯»å™¨ï¼ˆä¿®å¤ç‰ˆï¼‰</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;font-family:sans-serif;display:flex;flex-direction:column;}
    #top-bar{padding:6px;background:#eee;display:flex;gap:5px;flex-wrap:wrap;align-items:center;}
    #viewer{flex:1;overflow:auto;background:#fff;}
    #status{font-size:12px;padding:4px;background:#fff8dc;height:22px;}
    .highlight{background-color:yellow;}
    body.dark{background:#121212;color:#eee;}
  </style>
</head>
<body>
  <div id="top-bar">
    <input type="file" id="upload" accept=".epub" />
    <select id="chapters"><option>ğŸ“– é€‰æ‹©ç« èŠ‚</option></select>
    <button id="prev">â¬… ä¸Šä¸€é¡µ</button>
    <button id="next">â¡ ä¸‹ä¸€é¡µ</button>
    <button id="nextChapter">â© ä¸‹ä¸€ç« </button>
    <select id="fontSelect">
      <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
      <option value="serif">Serif</option>
      <option value="sans-serif">é»˜è®¤å­—ä½“</option>
    </select>
    <button id="incFont">ğŸ”¼ å­—å¤§</button>
    <button id="decFont">ğŸ”½ å­—å°</button>
    <button id="toggleDark">ğŸŒ™ å¤œé—´</button>
    <input type="file" id="dictUpload" accept=".txt,.xlsx">
    <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="lightblue">æµ…è“</option></select>
    <label><input type="checkbox" id="case"> åŒºåˆ†å¤§å°å†™</label>
  </div>
  <div id="viewer"></div>
  <div id="status">ğŸ“„ ç­‰å¾…ä¸Šä¼  EPUB æ–‡ä»¶...</div>

<script>
let book, rendition, highlights = new Set(), fontSize = 100, highlightColor = "yellow", caseSensitive = false;
let isDark = false;

const $ = id => document.getElementById(id);

function applyOverrides() {
  if (!rendition) return;
  rendition.themes.override("font-size", fontSize + "%");
  rendition.themes.override("font-family", $("fontSelect").value);
}

function applyHighlights(doc) {
  if (!highlights.size) return;
  const words = [...highlights].filter(w => w.length >= 2).sort((a,b)=>b.length-a.length)
    .map(w => w.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"));
  const flags = caseSensitive ? "g" : "gi";
  const regex = new RegExp("\\b(" + words.join("|") + ")\\b", flags);
  const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
  while (walker.nextNode()) {
    const node = walker.currentNode;
    const parent = node.parentNode;
    if (!node.nodeValue.trim()) continue;
    const span = document.createElement("span");
    span.innerHTML = node.nodeValue.replace(regex, match => 
      `<mark class='highlight' style='background-color:${highlightColor}'>${match}</mark>`);
    if (span.innerHTML !== node.nodeValue) parent.replaceChild(span, node);
  }
}

$("upload").onchange = function () {
  const file = this.files[0];
  book = ePub(file);
  rendition = book.renderTo("viewer", { flow: "scrolled-doc", width: "100%", height: "100%" });
  rendition.display();

  // ä¿è¯é«˜äº®æ¯ä¸€ç« èŠ‚éƒ½ç”Ÿæ•ˆ
  rendition.hooks.content.register(contents => {
    applyOverrides();
    applyHighlights(contents.document);
  });

  book.loaded.navigation.then(nav => {
    $("chapters").innerHTML = nav.toc.map(c => 
      `<option value="${c.href}">${c.label}</option>`).join("");
  });
};

$("chapters").onchange = () => rendition.display($("chapters").value);
$("prev").onclick = () => rendition.prev();
$("next").onclick = () => rendition.next();

$("nextChapter").onclick = () => {
  const spine = book.spine.spineItems;
  const idx = spine.findIndex(i => i.href === rendition.location.start.href);
  if (idx >= 0 && idx < spine.length - 1) {
    rendition.display(spine[idx + 1].href);
  }
};

$("fontSelect").onchange = applyOverrides;
$("incFont").onclick = () => { fontSize += 10; applyOverrides(); };
$("decFont").onclick = () => { fontSize = Math.max(50, fontSize - 10); applyOverrides(); };
$("toggleDark").onclick = () => {
  isDark = !isDark;
  document.body.classList.toggle("dark", isDark);
  applyOverrides();
};
$("colorSelect").onchange = () => highlightColor = $("colorSelect").value;
$("case").onchange = () => caseSensitive = $("case").checked;

$("dictUpload").onchange = async function () {
  highlights.clear();
  const file = this.files[0];
  if (file.name.endsWith(".txt")) {
    const text = await file.text();
    text.split(/\r?\n/).forEach(w => highlights.add(w.trim()));
  } else if (file.name.endsWith(".xlsx")) {
    const data = await file.arrayBuffer();
    const wb = XLSX.read(data, { type: "array" });
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
    rows.forEach(r => { if (r[0]) highlights.add(r[0].toString().trim()); });
  }
  $("status").textContent = "âœ… å·²åŠ è½½è¯è¡¨ï¼š" + highlights.size + " é¡¹";
  if (rendition) rendition.display(rendition.location.start.href);
};
</script>
</body>
</html>
