<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB é˜…è¯»å™¨ï¼šæœ€ç»ˆé«˜äº®ä¿®å¤ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      background: #f4f4f4;
    }
    #top-bar {
      padding: 6px;
      background: #eee;
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      align-items: center;
    }
    #viewer {
      flex-grow: 1;
      overflow: auto;
      background: #fff;
    }
    #status {
      font-size: 12px;
      padding: 4px;
      background: #fff8dc;
    }
    body.dark {
      background: #121212;
      color: #eee;
    }
    body.dark #viewer {
      background: #121212;
    }
    body.dark #top-bar {
      background: #333;
    }
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>ğŸ“– ç« èŠ‚</option></select>
  <button id="prev">â¬…</button><button id="next">â¡</button><button id="nextChapter">â© ä¸‹ä¸€ç« </button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">ç³»ç»Ÿé»˜è®¤</option>
  </select>
  <button id="incFont">ğŸ”¼</button><button id="decFont">ğŸ”½</button><button id="toggleDark">ğŸŒ™</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="lightblue">æµ…è“</option></select>
  <label><input type="checkbox" id="case">åŒºåˆ†å¤§å°å†™</label>
</div>
<div id="viewer"></div>
<div id="status">ğŸ“„ å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¸Šä¼  EPUBã€‚</div>

<script>
let book, rendition, highlights = new Set(), fontSize = 100, isDark = false, highlightColor = "yellow", caseSensitive = false;
const $ = id => document.getElementById(id);

function injectStyle(doc) {
  const style = doc.createElement("style");
  style.innerHTML = `
    body, p, div, span {
      font-family: "${$("fontSelect").value}" !important;
      font-size: ${fontSize}% !important;
      background: ${isDark ? "#121212" : "#fff"} !important;
      color: ${isDark ? "#eee" : "#000"} !important;
    }
  `;
  doc.head.appendChild(style);
}

function walkAndHighlight(node, regex) {
  if (!node || node.nodeType !== Node.ELEMENT_NODE || ["SCRIPT", "STYLE", "MARK"].includes(node.tagName)) return;
  const walker = document.createTreeWalker(node, NodeFilter.SHOW_TEXT, null, false);
  const toReplace = [];
  while (walker.nextNode()) {
    const textNode = walker.currentNode;
    const text = textNode.nodeValue;
    if (regex.test(text)) toReplace.push(textNode);
  }
  for (const textNode of toReplace) {
    const span = document.createElement("span");
    span.innerHTML = textNode.nodeValue.replace(regex, m => `<span style="background-color: ${highlightColor};">${m}</span>`);
    textNode.parentNode.replaceChild(span, textNode);
  }
}

function highlightWords(doc) {
  if (!highlights.size) return;
  const words = [...highlights].filter(w => w.length >= 2).map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const flags = caseSensitive ? "g" : "gi";
  const regex = new RegExp("(" + words.join("|") + ")", flags);
  walkAndHighlight(doc.body, regex);
}

$("upload").onchange = function () {
  const file = this.files[0];
  book = ePub(file);
  rendition = book.renderTo("viewer", { flow: "scrolled-doc", width: "100%", height: "100%" });
  rendition.display();

  rendition.hooks.content.register(contents => {
    const doc = contents.document;
    injectStyle(doc);
    highlightWords(doc);
  });

  book.loaded.navigation.then(nav => {
    $("chapters").innerHTML = nav.toc.map(c => `<option value="${c.href}">${c.label}</option>`).join("");
  });
};

$("chapters").onchange = () => rendition.display($("chapters").value);
$("prev").onclick = () => rendition.prev();
$("next").onclick = () => rendition.next();
$("nextChapter").onclick = () => {
  const idx = book.spine.spineItems.findIndex(i => i.href === rendition.location.start.href);
  if (idx >= 0 && idx < book.spine.spineItems.length - 1) rendition.display(book.spine.spineItems[idx + 1].href);
};

$("fontSelect").onchange = () => rendition.display(rendition.location.start.href);
$("incFont").onclick = () => { fontSize += 10; rendition.display(rendition.location.start.href); };
$("decFont").onclick = () => { fontSize = Math.max(50, fontSize - 10); rendition.display(rendition.location.start.href); };
$("toggleDark").onclick = () => {
  isDark = !isDark;
  document.body.classList.toggle("dark", isDark);
  rendition.display(rendition.location.start.href);
};
$("colorSelect").onchange = () => { highlightColor = $("colorSelect").value; rendition.display(rendition.location.start.href); };
$("case").onchange = () => { caseSensitive = $("case").checked; rendition.display(rendition.location.start.href); };

$("dictUpload").onchange = async function () {
  highlights.clear();
  const file = this.files[0];
  if (file.name.endsWith(".txt")) {
    const text = await file.text();
    text.split(/\r?\n/).forEach(w => highlights.add(w.trim()));
  } else if (file.name.endsWith(".xlsx")) {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }).forEach(r => {
      if (r[0]) highlights.add(r[0].toString().trim());
    });
  }
  $("status").textContent = `âœ… è¯è¡¨åŠ è½½å®Œæ¯•ï¼Œå…± ${highlights.size} ä¸ªè¯`;
  rendition.display(rendition.location.start.href);
};
</script>
</body>
</html>
