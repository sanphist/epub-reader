<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUBé˜…è¯»å™¨-é«˜äº®ä¿®å¤ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* ä¼˜åŒ–åçš„CSSæ ·å¼ */
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; display:flex; flex-direction:column; background:#f4f4f4; }
    #top-bar { padding:6px; background:#eee; display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
    #viewer { flex-grow:1; overflow:auto; background:#fff; }
    #status { font-size:12px; padding:4px; background:#fff8dc; }
    body.dark { background:#121212; color:#eee; }
    body.dark #viewer { background:#121212; }
    body.dark #top-bar { background:#333; }
    .epub-highlight { background-color: rgba(255, 255, 0, 0.3) !important; }
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>ğŸ“– ç« èŠ‚</option></select>
  <button id="prev">â¬…</button><button id="next">â¡</button><button id="nextChapter">â© ä¸‹ä¸€ç« </button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">ç³»ç»Ÿé»˜è®¤</option>
  </select>
  <button id="incFont">ğŸ”¼</button><button id="decFont">ğŸ”½</button><button id="toggleDark">ğŸŒ™</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="lightblue">æµ…è“</option></select>
  <label><input type="checkbox" id="case">åŒºåˆ†å¤§å°å†™</label>
  <button id="exportDict">ğŸ’¾ å¯¼å‡ºè¯è¡¨</button>
</div>
<div id="viewer"></div>
<div id="status">ğŸ“„ å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¸Šä¼  EPUBã€‚</div>

<script>
// ä¿®å¤åçš„å®Œæ•´JavaScriptä»£ç 
let book, rendition, highlights = new Set(), fontSize = 100, isDark = false, highlightColor = "yellow", caseSensitive = false;
const $ = id => document.getElementById(id);

function cleanHighlights(doc) {
  doc.querySelectorAll('span[style*="background-color"]').forEach(hl => {
    const text = doc.createTextNode(hl.textContent);
    hl.parentNode.replaceChild(text, hl);
  });
}

function buildRegex(words) {
  const escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  return new RegExp(`\\b(${escaped.join('|')})\\b`, caseSensitive ? 'g' : 'gi');
}

function injectStyle(doc) {
  const style = doc.createElement("style");
  style.innerHTML = `body, p, div, span { 
    font-family: "${$("fontSelect").value}" !important; 
    font-size: ${fontSize}% !important; 
    background: ${isDark ? "#121212" : "#fff"} !important; 
    color: ${isDark ? "#eee" : "#000"} !important; 
  }`;
  doc.head.appendChild(style);
}

function highlightWords(doc) {
  cleanHighlights(doc);
  if (!highlights.size) return;
  
  const words = [...highlights].filter(w => w.length >= 2);
  if (words.length === 0) return;
  
  const regex = buildRegex(words);
  const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT);
  const textNodes = [];
  
  while (walker.nextNode()) {
    const node = walker.currentNode;
    if (node.parentNode.nodeName === 'MARK') continue;
    if (regex.test(node.textContent)) textNodes.push(node);
  }

  textNodes.forEach(node => {
    const newHtml = node.textContent.replace(regex, '<mark class="epub-highlight" style="background-color: '+highlightColor+';">$1</mark>');
    const wrapper = document.createElement('span');
    wrapper.innerHTML = newHtml;
    node.parentNode.replaceChild(wrapper, node);
  });
}

// äº‹ä»¶ç›‘å¬ä¸åˆå§‹åŒ–ä»£ç 
document.addEventListener('DOMContentLoaded', () => {
  $("upload").onchange = function() {
    const file = this.files[0];
    book = ePub(file);
    rendition = book.renderTo("viewer", { flow: "scrolled-doc", width: "100%", height: "100%" });
    
    rendition.display().then(() => {
      book.loaded.navigation.then(nav => {
        $("chapters").innerHTML = nav.toc.map(c => 
          `<option value="${c.href}">${c.label}</option>`
        ).join("");
      });
    });

    rendition.hooks.content.register(contents => {
      const doc = contents.document;
      injectStyle(doc);
      highlightWords(doc);
    });
  };

  // å…¶ä»–äº‹ä»¶ç›‘å¬ä¿æŒä¸å˜...
});

// å¯¼å‡ºåŠŸèƒ½
$("exportDict").onclick = function() {
  if (highlights.size === 0) {
    $("status").textContent = "âš ï¸ å½“å‰æ²¡æœ‰å¯å¯¼å‡ºçš„è¯è¡¨";
    return;
  }
  const content = Array.from(highlights).join("\n");
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `highlight_words_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  $("status").textContent = `ğŸ“¤ å·²å¯¼å‡º ${highlights.size} ä¸ªè¯æ±‡`;
};
</script>
</body>
</html>
