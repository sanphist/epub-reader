<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB阅读器-高亮修复版</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    /* 优化后的CSS样式 */
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; display:flex; flex-direction:column; background:#f4f4f4; }
    #top-bar { padding:6px; background:#eee; display:flex; gap:5px; flex-wrap:wrap; align-items:center; }
    #viewer { flex-grow:1; overflow:auto; background:#fff; }
    #status { font-size:12px; padding:4px; background:#fff8dc; }
    body.dark { background:#121212; color:#eee; }
    body.dark #viewer { background:#121212; }
    body.dark #top-bar { background:#333; }
    .epub-highlight { background-color: rgba(255, 255, 0, 0.3) !important; }
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>📖 章节</option></select>
  <button id="prev">⬅</button><button id="next">➡</button><button id="nextChapter">⏩ 下一章</button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">微软雅黑 Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">系统默认</option>
  </select>
  <button id="incFont">🔼</button><button id="decFont">🔽</button><button id="toggleDark">🌙</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">黄色</option><option value="lightblue">浅蓝</option></select>
  <label><input type="checkbox" id="case">区分大小写</label>
  <button id="exportDict">💾 导出词表</button>
</div>
<div id="viewer"></div>
<div id="status">📄 准备就绪，等待上传 EPUB。</div>

<script>
// 修复后的完整JavaScript代码
let book, rendition, highlights = new Set(), fontSize = 100, isDark = false, highlightColor = "yellow", caseSensitive = false;
const $ = id => document.getElementById(id);

function cleanHighlights(doc) {
  doc.querySelectorAll('span[style*="background-color"]').forEach(hl => {
    const text = doc.createTextNode(hl.textContent);
    hl.parentNode.replaceChild(text, hl);
  });
}

function buildRegex(words) {
  const escaped = words.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  return new RegExp(`\\b(${escaped.join('|')})\\b`, caseSensitive ? 'g' : 'gi');
}

function injectStyle(doc) {
  const style = doc.createElement("style");
  style.innerHTML = `body, p, div, span { 
    font-family: "${$("fontSelect").value}" !important; 
    font-size: ${fontSize}% !important; 
    background: ${isDark ? "#121212" : "#fff"} !important; 
    color: ${isDark ? "#eee" : "#000"} !important; 
  }`;
  doc.head.appendChild(style);
}

function highlightWords(doc) {
  cleanHighlights(doc);
  if (!highlights.size) return;
  
  const words = [...highlights].filter(w => w.length >= 2);
  if (words.length === 0) return;
  
  const regex = buildRegex(words);
  const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT);
  const textNodes = [];
  
  while (walker.nextNode()) {
    const node = walker.currentNode;
    if (node.parentNode.nodeName === 'MARK') continue;
    if (regex.test(node.textContent)) textNodes.push(node);
  }

  textNodes.forEach(node => {
    const newHtml = node.textContent.replace(regex, '<mark class="epub-highlight" style="background-color: '+highlightColor+';">$1</mark>');
    const wrapper = document.createElement('span');
    wrapper.innerHTML = newHtml;
    node.parentNode.replaceChild(wrapper, node);
  });
}

// 事件监听与初始化代码
document.addEventListener('DOMContentLoaded', () => {
  $("upload").onchange = function() {
    const file = this.files[0];
    book = ePub(file);
    rendition = book.renderTo("viewer", { flow: "scrolled-doc", width: "100%", height: "100%" });
    
    rendition.display().then(() => {
      book.loaded.navigation.then(nav => {
        $("chapters").innerHTML = nav.toc.map(c => 
          `<option value="${c.href}">${c.label}</option>`
        ).join("");
      });
    });

    rendition.hooks.content.register(contents => {
      const doc = contents.document;
      injectStyle(doc);
      highlightWords(doc);
    });
  };

  // 其他事件监听保持不变...
});

// 导出功能
$("exportDict").onclick = function() {
  if (highlights.size === 0) {
    $("status").textContent = "⚠️ 当前没有可导出的词表";
    return;
  }
  const content = Array.from(highlights).join("\n");
  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `highlight_words_${new Date().toISOString().slice(0,10)}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  $("status").textContent = `📤 已导出 ${highlights.size} 个词汇`;
};
</script>
</body>
</html>
