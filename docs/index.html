
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EPUB é˜…è¯»å™¨æœ€ç»ˆä¿®å¤ç‰ˆ</title>
  <script src="https://cdn.jsdelivr.net/npm/jszip/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;display:flex;flex-direction:column;font-family:sans-serif;background:#f4f4f4;}
    #top-bar{padding:6px;background:#eee;display:flex;gap:5px;flex-wrap:wrap;align-items:center;}
    #viewer{flex-grow:1;overflow:auto;background:#fff;}
    #status{font-size:12px;padding:4px;background:#fff8dc;}
    .dark body,#viewer.dark{background:#121212;color:#eee;}
  </style>
</head>
<body>
<div id="top-bar">
  <input type="file" id="upload" accept=".epub">
  <select id="chapters"><option>ğŸ“– ç« èŠ‚</option></select>
  <button id="prev">â¬… ä¸Šä¸€é¡µ</button>
  <button id="next">â¡ ä¸‹ä¸€é¡µ</button>
  <button id="nextChapter">â© ä¸‹ä¸€ç« </button>
  <select id="fontSelect">
    <option value="Microsoft YaHei Light">å¾®è½¯é›…é»‘ Light</option>
    <option value="serif">Serif</option>
    <option value="sans-serif">é»˜è®¤å­—ä½“</option>
  </select>
  <button id="incFont">ğŸ”¼ å¤§</button>
  <button id="decFont">ğŸ”½ å°</button>
  <button id="toggleDark">ğŸŒ™ å¤œ</button>
  <input type="file" id="dictUpload" accept=".txt,.xlsx">
  <select id="colorSelect"><option value="yellow">é»„è‰²</option><option value="lightblue">è“è‰²</option></select>
  <label><input type="checkbox" id="case">åŒºåˆ†å¤§å°å†™</label>
</div>
<div id="viewer"></div>
<div id="status">ğŸ“„ å‡†å¤‡å°±ç»ªï¼Œè¯·ä¸Šä¼  EPUB æ–‡ä»¶ã€‚</div>

<script>
let book, rendition, highlights = new Set(), fontSize = 100, isDark = false, highlightColor = "yellow", caseSensitive = false;

const $ = id => document.getElementById(id);

function injectStyle(doc) {
  const style = doc.createElement("style");
  style.innerHTML = `
    body, p, div, span {
      font-family: "${$("fontSelect").value}" !important;
      font-size: ${fontSize}% !important;
      background: ${isDark ? "#121212" : "#fff"} !important;
      color: ${isDark ? "#eee" : "#000"} !important;
    }
    mark.highlight {
      background-color: ${highlightColor} !important;
    }
  `;
  doc.head.appendChild(style);
}

function highlightWords(doc) {
  if (!highlights.size) return;
  const words = [...highlights].filter(w=>w.length>1).map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
  const regex = new RegExp(`\\b(${words.join("|")})\\b`, caseSensitive ? "g" : "gi");
  const walker = doc.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
  while (walker.nextNode()) {
    const node = walker.currentNode;
    const parent = node.parentNode;
    if (!node.nodeValue.trim()) continue;
    const span = document.createElement("span");
    span.innerHTML = node.nodeValue.replace(regex, m =>
      `<mark class='highlight'>${m}</mark>`);
    if (span.innerHTML !== node.nodeValue) parent.replaceChild(span, node);
  }
}

$("upload").onchange = function () {
  book = ePub(this.files[0]);
  rendition = book.renderTo("viewer", { flow: "scrolled-doc", width: "100%", height: "100%" });
  rendition.display();

  rendition.hooks.content.register(contents => {
    const doc = contents.document;
    injectStyle(doc);
    highlightWords(doc);
  });

  book.loaded.navigation.then(nav => {
    $("chapters").innerHTML = nav.toc.map(c =>
      `<option value="${c.href}">${c.label}</option>`).join("");
  });
};

$("chapters").onchange = () => rendition.display($("chapters").value);
$("prev").onclick = () => rendition.prev();
$("next").onclick = () => rendition.next();

$("nextChapter").onclick = () => {
  const idx = book.spine.spineItems.findIndex(i => i.href === rendition.location.start.href);
  if (idx >= 0 && idx < book.spine.spineItems.length - 1)
    rendition.display(book.spine.spineItems[idx + 1].href);
};

$("fontSelect").onchange = () => { if (rendition) rendition.display(rendition.location.start.href); };
$("incFont").onclick = () => { fontSize += 10; if (rendition) rendition.display(rendition.location.start.href); };
$("decFont").onclick = () => { fontSize = Math.max(50, fontSize - 10); if (rendition) rendition.display(rendition.location.start.href); };
$("toggleDark").onclick = () => { isDark = !isDark; document.body.classList.toggle("dark", isDark); if (rendition) rendition.display(rendition.location.start.href); };
$("colorSelect").onchange = () => { highlightColor = $("colorSelect").value; if (rendition) rendition.display(rendition.location.start.href); };
$("case").onchange = () => { caseSensitive = $("case").checked; if (rendition) rendition.display(rendition.location.start.href); };

$("dictUpload").onchange = async function () {
  highlights.clear();
  const f = this.files[0];
  if (f.name.endsWith(".txt")) {
    const text = await f.text();
    text.split(/\r?\n/).forEach(w => highlights.add(w.trim()));
  } else if (f.name.endsWith(".xlsx")) {
    const buf = await f.arrayBuffer();
    const wb = XLSX.read(buf, { type: "array" });
    XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 }).forEach(r => {
      if (r[0]) highlights.add(r[0].toString().trim());
    });
  }
  $("status").textContent = `âœ… å·²åŠ è½½è¯è¡¨ï¼š${highlights.size} é¡¹`;
  if (rendition) rendition.display(rendition.location.start.href);
};
</script>
</body>
</html>
