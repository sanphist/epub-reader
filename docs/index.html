<!DOCTYPE html>
<div id="status">ğŸ“„ Reader v4 loaded â€” ç­‰å¾…ä¸Šä¼  EPUB æ–‡ä»¶...</div>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>EPUB Reader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- âœ… ä¿è¯å…¼å®¹çš„ CDN é¡ºåº -->
  <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://unpkg.com/epubjs/dist/epub.min.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      background: #f4f4f4;
      display: flex;
      flex-direction: column;
    }

    #top-bar {
      padding: 10px;
      background: #fafafa;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    #top-bar > * {
      font-size: 16px;
      padding: 4px 8px;
    }

    #viewer {
      flex-grow: 1;
      width: 100%;
      background: white;
    }

    #progress-bar {
      height: 4px;
      background: #4caf50;
      width: 0%;
      transition: width 0.3s ease;
    }

    #status {
      font-size: 14px;
      padding: 10px;
      color: #333;
      background: #fff8dc;
      min-height: 50px;
      overflow-y: auto;
    }

    .dark-mode {
      background-color: #111 !important;
      color: #eee !important;
    }

    .dark-mode #viewer {
      background-color: #222 !important;
    }

    .dark-mode select, .dark-mode button, .dark-mode input {
      background-color: #333 !important;
      color: #eee !important;
      border-color: #666 !important;
    }
  </style>
</head>
<body>

  <div id="top-bar">
    <input type="file" id="upload" accept=".epub" />
    <select id="chapters">
      <option value="">ğŸ“– è¯·é€‰æ‹©ç« èŠ‚</option>
    </select>
    <button id="prev">â¬…ï¸ ä¸Šä¸€é¡µ</button>
    <button id="next">â¡ï¸ ä¸‹ä¸€é¡µ</button>
    <button id="zoom-in">ğŸ” æ”¾å¤§</button>
    <button id="zoom-out">ğŸ” ç¼©å°</button>
    <button id="toggle-mode">ğŸŒ™ å¤œé—´</button>
  </div>

  <div id="progress-bar"></div>
  <div id="viewer"></div>
  <div id="status">ğŸ“„ å‡†å¤‡å°±ç»ªï¼Œç­‰å¾…ä¸Šä¼  EPUB æ–‡ä»¶...</div>

  <script>
    const upload = document.getElementById("upload");
    const viewer = document.getElementById("viewer");
    const status = document.getElementById("status");
    const progressBar = document.getElementById("progress-bar");
    const chaptersDropdown = document.getElementById("chapters");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const zoomInBtn = document.getElementById("zoom-in");
    const zoomOutBtn = document.getElementById("zoom-out");
    const toggleModeBtn = document.getElementById("toggle-mode");

    let book, rendition;
    let fontSize = 100; // ç™¾åˆ†æ¯”
    let currentKey = "epub-book-position";

    function setStatus(msg) {
      status.textContent = msg;
    }

    function logError(err) {
      console.error(err);
      setStatus("âŒ é”™è¯¯: " + (err?.message || err));
    }

    function setProgress(percent) {
      progressBar.style.width = percent + "%";
    }

    window.onerror = function (msg, url, lineNo, columnNo, error) {
      logError(error || msg);
      return true;
    };

    upload.addEventListener("change", function () {
      const file = this.files[0];
      if (!file) return;

      setProgress(10);
      setStatus("ğŸ“¦ æ­£åœ¨åŠ è½½ EPUB æ–‡ä»¶ï¼š" + file.name);
      chaptersDropdown.innerHTML = '<option value="">ğŸ“– è¯·é€‰æ‹©ç« èŠ‚</option>';

      try {
        book = ePub(file);
        rendition = book.renderTo(viewer, {
          width: "100%",
          height: "100%",
        });

        currentKey = "epub-" + file.name + "-pos";
        setProgress(30);

        book.ready.then(() => {
          setProgress(60);

          // è‡ªåŠ¨æ¢å¤ä½ç½®
          const saved = localStorage.getItem(currentKey);
          const start = saved || book.spine.get(0).href;

          rendition.display(start).then(() => {
            setProgress(100);
            setStatus("âœ… EPUB åŠ è½½æˆåŠŸï¼");
          });

          rendition.on("relocated", location => {
            localStorage.setItem(currentKey, location.start.href);
          });

          return book.navigation.loaded;
        }).then(nav => {
          nav.toc.forEach((item, index) => {
            const option = document.createElement("option");
            option.textContent = item.label?.trim() || `ç« èŠ‚ ${index + 1}`;
            option.value = item.href;
            chaptersDropdown.appendChild(option);
          });
        }).catch(logError);
      } catch (err) {
        logError(err);
      }
    });

    chaptersDropdown.addEventListener("change", function () {
      const href = this.value;
      if (href && rendition) {
        rendition.display(href).then(() => {
          const title = this.options[this.selectedIndex].text;
          setStatus("ğŸ“˜ è·³è½¬è‡³ï¼š" + title);
        });
      }
    });

    prevBtn.addEventListener("click", () => {
      if (rendition) rendition.prev();
    });

    nextBtn.addEventListener("click", () => {
      if (rendition) rendition.next();
    });

    zoomInBtn.addEventListener("click", () => {
      if (rendition) {
        fontSize += 10;
        rendition.themes.fontSize(fontSize + "%");
      }
    });

    zoomOutBtn.addEventListener("click", () => {
      if (rendition && fontSize > 50) {
        fontSize -= 10;
        rendition.themes.fontSize(fontSize + "%");
      }
    });

    toggleModeBtn.addEventListener("click", () => {
      document.body.classList.toggle("dark-mode");
    });
  </script>
</body>
</html>
